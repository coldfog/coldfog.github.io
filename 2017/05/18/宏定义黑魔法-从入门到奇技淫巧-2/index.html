<!doctype html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="宏,C,C++,预处理,宏定义黑魔法系列,"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0"><meta name="description" content="这里是这个系列的第二篇。这次我们开始关注一些更复杂的宏特性————object-like 宏的递归展开。"><meta name="keywords" content="宏,C,C++,预处理,宏定义黑魔法系列"><meta property="og:type" content="article"><meta property="og:title" content="宏定义黑魔法-从入门到奇技淫巧 (2)"><meta property="og:url" content="http://feng.zone/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/index.html"><meta property="og:site_name" content="Feng.Zone"><meta property="og:description" content="这里是这个系列的第二篇。这次我们开始关注一些更复杂的宏特性————object-like 宏的递归展开。"><meta property="og:image" content="http://feng.zone/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/thb_obj_like_recur.png"><meta property="og:updated_time" content="2017-05-20T13:23:14.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="宏定义黑魔法-从入门到奇技淫巧 (2)"><meta name="twitter:description" content="这里是这个系列的第二篇。这次我们开始关注一些更复杂的宏特性————object-like 宏的递归展开。"><meta name="twitter:image" content="http://feng.zone/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/thb_obj_like_recur.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",sidebar:{position:"right",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://feng.zone/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/"><title> 宏定义黑魔法-从入门到奇技淫巧 (2) | Feng.Zone</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src="https://www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-97857802-1","auto"),ga("send","pageview")</script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b1d8e92cfae4a60754ef1bc11a548063";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Feng.Zone</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Personal webside & blog</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://feng.zone/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="诺依曼の尧"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Feng.Zone"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 宏定义黑魔法-从入门到奇技淫巧 (2)</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-18T16:12:06+08:00">2017-05-18</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/编程/" itemprop="url" rel="index"><span itemprop="name">编程</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/" itemprop="commentCount"></span></a></span> <span id="/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/" class="leancloud_visitors" data-flag-title="宏定义黑魔法-从入门到奇技淫巧 (2)"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>这里是这个系列的第二篇。这次我们开始关注一些更复杂的宏特性————object-like 宏的递归展开。</p><a id="more"></a><h1 id="obj-like-的递归展开"><a href="#obj-like-的递归展开" class="headerlink" title="obj-like 的递归展开"></a>obj-like 的递归展开</h1><p>在替换列表中出现的宏会被展开，这一过程将递归的进行下去，且是深度优先的。例如：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> foo foz bar</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> bar 123</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> foz baz</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> baz 1</span></div><div class="line"></div><div class="line">foo</div><div class="line">-&gt; foz bar</div><div class="line">-&gt; baz bar</div><div class="line">-&gt; <span class="number">1</span> bar</div><div class="line">-&gt; <span class="number">1</span> <span class="number">123</span></div></pre></td></tr></table></figure><p>可以看到，当一个宏完全展开后，下一个宏才会被展开。但是，如果只有这一条规则那么很容易出现无限递归的情况。例如：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> foo bar</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> bar foo</span></div><div class="line"></div><div class="line">foo</div><div class="line">-&gt; bar</div><div class="line">-&gt; foo</div><div class="line">-&gt; 无限循环</div></pre></td></tr></table></figure><p>因此在标准中对宏中涉及自指的部分做了限制：</p><blockquote><p>If the name of the macro being replaced is found during this scan of the replacement list (not including the rest of the source file’s preprocessing tokens), it is not replaced. Furthermore, if any nested replacements encounter the name of the macro being replaced, it is not replaced. These nonreplaced macro name preprocessing tokens are no longer available for further replacement even if they are later (re)examined in contexts in which that macro name preprocessing token would otherwise have been replaced.</p><footer><strong>16.3.4 cpp.recan</strong><cite>ISO n3690</cite></footer></blockquote><p>从字面含义理解很简单，主要表达了两点：</p><ol><li>在展开的过程中，如果替换列表中出现了被展开宏，那么该被展开宏不会被展开。</li><li>更进一步的，在展开的过程中，任何嵌套的展开过程中出现了被展开宏，该被展开宏也不会被展开。</li></ol><p>听起来很绕不是么，这属于典型的，说起来绕但是实现起来简单。没关系，我们可以这样理解。每次展开的时候会创建一个「蓝色集合」（一般将标记过的 token 称作 painted-blue），这个蓝色集合由本次展开的父级展开的蓝色集合加上当前展开的宏组成。然后每次对替换列表进行扫描的时候，所有在当前蓝色集合中的宏都不会被展开。挺起来还是很绕的话，我们来看一个实际展开的例子：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> foo foo a bar b bar baz c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> bar foo 12</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> baz bar 13</span></div><div class="line"></div><div class="line">foo</div></pre></td></tr></table></figure><p>定义三个宏 <code>foo</code>, <code>bar</code>, <code>baz</code>，展开过程如下图所示：</p> <a href="/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/obj_like_recur.png" class="fancybox fancybox.image" rel="group" title=""><img src="/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/thb_obj_like_recur.png" alt="obj_like_recur.png" title=""></a><p>展开步骤为：</p><ol><li>对于宏 <code>foo</code> 的展开，一开始蓝色集合是空集，没有禁止展开的宏名。所以我们对 <code>foo</code> 进行展开。展开结果是 <code>foo a bar b bar baz c</code>，每次展开都会创建一个新的蓝色集合，该蓝色集合继承自父级的蓝色集合并添加本次展开的宏名。于是新的蓝色集合就是<code>空集</code>+<code>foo</code>。</li><li>逐个 token 向后检查<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>，此时蓝色集合为<code>{foo}</code>，所以第一个 <code>foo</code> 不展开。<code>a</code>不是一个宏，放着不管就行。<code>bar</code>不在蓝色集合里，展开为<code>foo 12</code>。展开的同时创建新的蓝色集合<code>{foo, bar}</code>。</li><li>对 <code>bar</code> 展开的结果继续展开。此时的蓝色集合为<code>{foo, bar}</code>，<code>foo</code> 在集合内，不展开。<code>12</code>保持不变。到此 <code>bar</code>完全展开，回退至上一层。注意，展开的顺序是，当一个宏完全展开后，才会去展开下一个宏，这一点很重要。</li><li><code>b</code> 不变。处理<code>bar</code>。注意，每一层展开的蓝色集合是不变的，和子展开无关。此时蓝色集合为<code>{foo}</code>。而不是<code>{foo bar}</code>。所以 <code>bar</code> 可以继续展开。展开过程和上一个 <code>bar</code> 一致，略去。</li><li>处理<code>baz</code>。<code>baz</code> 不在蓝色集合里，展开为<code>bar 13</code> 创建蓝色集合<code>{foo baz}</code>。</li><li>展开<code>bar</code>。注意，此处蓝色集合中并没有 <code>bar</code>，所以<code>bar</code>可以继续展开。因为蓝色集合只继承自己的父级，和其他的无关。展开过程与之前的 bar 展开过程一致，略去。但需注意和之前不同的是，展开后蓝色集合变为<code>{foo, baz, bar}</code>如果 <code>bar</code> 中有<code>baz</code>，则 <code>baz</code>不会继续展开。</li></ol><p>最终，展开的结果是<code>foo a foo 12 b foo 12 foo 12 13 c</code>。<br>大家可以动手自己写几个例子试试看。虽然比较绕，但是掌握了以后还是很直白的。</p><p>本节内容到此结束。为了方便说明本节在介绍展开过程的时候略去了一些细节，这些细节将在下一节中交代。下一节我们来学习更加烧脑的 function-like 宏的递归展开。</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none;padding-left:0"><li id="fn:1"><span style="display:inline-block;vertical-align:top;padding-right:10px">1.</span><span style="display:inline-block;vertical-align:top">实际操作过程稍有不同，不过此处这么理解并不会产生问题。具体的差别在下一节中将会交代。</span> <a href="#fnref:1" rev="footnote">↩</a></li></ol></div></div></div><div></div><div></div><div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/宏/" rel="tag"># 宏</a> <a href="/tags/C/" rel="tag"># C</a> <a href="/tags/C/" rel="tag"># C++</a> <a href="/tags/预处理/" rel="tag"># 预处理</a> <a href="/tags/宏定义黑魔法系列/" rel="tag"># 宏定义黑魔法系列</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/05/20/宏定义黑魔法-从入门到奇技淫巧-3/" rel="next" title="宏定义黑魔法-从入门到奇技淫巧 (3)"><i class="fa fa-chevron-left"></i> 宏定义黑魔法-从入门到奇技淫巧 (3)</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2017/05/17/宏定义黑魔法-从入门到奇技淫巧-1/" rel="prev" title="宏定义黑魔法-从入门到奇技淫巧 (1)">宏定义黑魔法-从入门到奇技淫巧 (1)<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="诺依曼の尧"><p class="site-author-name" itemprop="name">诺依曼の尧</p><p class="site-description motion-element" itemprop="description">游戏开发 业余画画</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">7</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">2</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/coldfog" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/feng-yu-yao" target="_blank" title="知乎"><i class="fa fa-fw fa-user-circle"></i> 知乎</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#obj-like-的递归展开"><span class="nav-number">1.</span> <span class="nav-text">obj-like 的递归展开</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2017</span><span class="with-love"><i class="fa fa-mars"></i></span> <span class="author" itemprop="copyrightHolder">诺依曼の尧</span></div><div class="powered-by"> 由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><script id="dsq-count-scr" src="https://feng-zone.disqus.com/count.js" async></script><script type="text/javascript">var disqus_config=function(){this.page.url="http://feng.zone/2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/",this.page.identifier="2017/05/18/宏定义黑魔法-从入门到奇技淫巧-2/",this.page.title="宏定义黑魔法-从入门到奇技淫巧 (2)"},d=document,s=d.createElement("script");s.src="https://feng-zone.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script><script>AV.initialize("Ad6RS9oEf6JH4GjvYmwQzOio-gzGzoHsz","H7qLYCtHDgD7sINe02JyB8PO")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){if(0===e.length)return void o.find(".leancloud-visitors-count").text(0);for(var t=0;t<e.length;t++){var i=e[t],s=i.get("url"),r=i.get("time"),l=document.getElementById(s);$(l).find(".leancloud-visitors-count").text(r)}for(var t=0;t<n.length;t++){var s=n[t],l=document.getElementById(s),c=$(l).find(".leancloud-visitors-count");""==c.text()&&c.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var s=new e,r=new AV.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0),s.setACL(r),s.set("title",o),s.set("url",n),s.set("time",1),s.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script></body></html>